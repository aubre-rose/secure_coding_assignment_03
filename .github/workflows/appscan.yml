name: AppScan Security Scan
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  appscan:
    name: AppScan CodeSweep
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for better analysis
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Debug - List files
      run: |
        echo "Current directory structure:"
        find . -type f -name "*.py" -o -name "*.js" -o -name "*.java" -o -name "*.go" | head -20
        echo "Total files found: $(find . -type f | wc -l)"
    
    - name: Run AppScan CodeSweep
      uses: hcl-tech-software/appscan-codesweep-action@v1
      with:
        # Optional: Add your API keys if you have them
        # key_id: ${{ secrets.APPSCAN_KEY_ID }}
        # key_secret: ${{ secrets.APPSCAN_API_KEY }}
        scan_path: "."
        output_format: "sarif"
        output_file: "appscan-results.sarif"
        fail_on_issues: false  # Change to true for strict checking
        extra_args: "--verbose"  # Get detailed logs
    
    - name: Upload results
      if: always()  # Upload even if scan fails
      uses: actions/upload-artifact@v3
      with:
        name: appscan-security-results
        path: |
          appscan-results.sarif
          appscan-codesweep.log
